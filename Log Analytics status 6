#!/bin/bash

# Comprehensive Azure Resources Activity Audit
# Checks last log/metric activity for all resources across all subscriptions

set -e

DAYS_TO_CHECK=90
OUTPUT_FILE="azure_resources_activity_audit_$(date +%Y%m%d_%H%M%S).csv"
TEMP_DIR="/tmp/resource_audit_$$"
mkdir -p "$TEMP_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

echo "========================================================="
echo "Azure Resources Last Activity Audit - All Subscriptions"
echo "========================================================="
echo ""

# Check prerequisites
if ! command -v az &> /dev/null; then
    echo -e "${RED}Error: Azure CLI is not installed${NC}"
    exit 1
fi

if ! az account show &> /dev/null; then
    echo -e "${RED}Error: Not logged into Azure${NC}"
    exit 1
fi

# CSV Header
echo "SubscriptionName,SubscriptionId,ResourceName,ResourceType,ResourceGroup,Location,LogAnalyticsWorkspace,LastLogActivity,DaysSinceLastLog,HasRecentMetrics,LastMetricActivity,DaysSinceLastMetric,Status,Tags" > "$OUTPUT_FILE"

# Get all enabled subscriptions
echo "Fetching all subscriptions..."
az account list --query "[?state=='Enabled'].[name,id]" -o tsv > "$TEMP_DIR/subscriptions.txt"

TOTAL_SUBS=$(wc -l < "$TEMP_DIR/subscriptions.txt")
echo -e "${CYAN}Found $TOTAL_SUBS enabled subscription(s)${NC}"
echo ""

TOTAL_RESOURCES=0
ACTIVE_RESOURCES=0
INACTIVE_RESOURCES=0
NO_DATA_RESOURCES=0
SUB_COUNTER=0

# Process each subscription
while IFS=$'\t' read -r SUB_NAME SUB_ID; do
    SUB_COUNTER=$((SUB_COUNTER + 1))
    
    echo "============================================================"
    echo -e "${BLUE}[$SUB_COUNTER/$TOTAL_SUBS] Subscription: $SUB_NAME${NC}"
    echo "============================================================"
    
    # Set subscription
    az account set --subscription "$SUB_ID" 2>/dev/null || {
        echo -e "${RED}Failed to set subscription${NC}"
        continue
    }
    
    # Get all Log Analytics Workspaces in this subscription
    echo "Finding Log Analytics Workspaces..."
    az monitor log-analytics workspace list --query "[].{name:name,id:id,customerId:customerId}" -o json > "$TEMP_DIR/workspaces_${SUB_COUNTER}.json" 2>/dev/null || echo "[]" > "$TEMP_DIR/workspaces_${SUB_COUNTER}.json"
    
    WORKSPACE_COUNT=$(jq '. | length' "$TEMP_DIR/workspaces_${SUB_COUNTER}.json")
    echo -e "${CYAN}Found $WORKSPACE_COUNT Log Analytics Workspace(s)${NC}"
    
    # Get all resources
    echo "Fetching all resources in subscription..."
    az resource list -o json > "$TEMP_DIR/resources_${SUB_COUNTER}.json" 2>/dev/null || {
        echo -e "${YELLOW}Failed to fetch resources${NC}"
        continue
    }
    
    RESOURCE_COUNT=$(jq '. | length' "$TEMP_DIR/resources_${SUB_COUNTER}.json")
    echo -e "${CYAN}Found $RESOURCE_COUNT resource(s)${NC}"
    echo ""
    
    if [ "$RESOURCE_COUNT" -eq 0 ]; then
        continue
    fi
    
    RES_COUNTER=0
    
    # Process each resource
    jq -c '.[]' "$TEMP_DIR/resources_${SUB_COUNTER}.json" | while read -r resource; do
        RES_COUNTER=$((RES_COUNTER + 1))
        TOTAL_RESOURCES=$((TOTAL_RESOURCES + 1))
        
        RES_NAME=$(echo "$resource" | jq -r '.name')
        RES_TYPE=$(echo "$resource" | jq -r '.type')
        RES_RG=$(echo "$resource" | jq -r '.resourceGroup')
        RES_LOCATION=$(echo "$resource" | jq -r '.location')
        RES_ID=$(echo "$resource" | jq -r '.id')
        RES_TAGS=$(echo "$resource" | jq -r '.tags | to_entries | map("\(.key)=\(.value)") | join(";") // "None"')
        
        echo -e "${YELLOW}[$RES_COUNTER/$RESOURCE_COUNT] $RES_NAME${NC}"
        echo "  Type: $RES_TYPE"
        echo "  Resource Group: $RES_RG"
        
        LAST_LOG_DATE="Never"
        DAYS_SINCE_LOG="N/A"
        LAST_METRIC_DATE="Never"
        DAYS_SINCE_METRIC="N/A"
        HAS_RECENT_METRICS="No"
        STATUS="NO_DATA"
        WORKSPACE_FOUND="None"
        
        # Check diagnostic settings to find connected Log Analytics workspace
        DIAG_SETTINGS=$(az monitor diagnostic-settings list --resource "$RES_ID" -o json 2>/dev/null || echo "[]")
        
        if [ "$(echo "$DIAG_SETTINGS" | jq '. | length')" -gt 0 ]; then
            WORKSPACE_ID=$(echo "$DIAG_SETTINGS" | jq -r '.[0].workspaceId // empty' | head -1)
            
            if [ -n "$WORKSPACE_ID" ]; then
                WORKSPACE_NAME=$(echo "$WORKSPACE_ID" | awk -F'/' '{print $NF}')
                WORKSPACE_FOUND="$WORKSPACE_NAME"
                echo "  Connected to: $WORKSPACE_NAME"
                
                # Query logs in the workspace for this resource
                RESOURCE_QUERY="search *
                | where TimeGenerated > ago(365d)
                | where _ResourceId =~ \"$RES_ID\"
                | summarize LastLog = max(TimeGenerated), LogCount = count()
                | project LastLog, LogCount"
                
                echo "  Querying logs..."
                LOG_RESULT=$(az monitor log-analytics query \
                    -w "$WORKSPACE_ID" \
                    --analytics-query "$RESOURCE_QUERY" \
                    -o json 2>/dev/null || echo "[]")
                
                if [ "$(echo "$LOG_RESULT" | jq '. | length')" -gt 0 ]; then
                    LAST_LOG_DATE=$(echo "$LOG_RESULT" | jq -r '.[0].LastLog // "Never"')
                    LOG_COUNT=$(echo "$LOG_RESULT" | jq -r '.[0].LogCount // 0')
                    
                    if [ "$LAST_LOG_DATE" != "Never" ] && [ "$LAST_LOG_DATE" != "null" ]; then
                        LAST_LOG_EPOCH=$(date -d "$LAST_LOG_DATE" +%s 2>/dev/null || echo "0")
                        CURRENT_EPOCH=$(date +%s)
                        DAYS_SINCE_LOG=$((( CURRENT_EPOCH - LAST_LOG_EPOCH ) / 86400))
                        
                        echo -e "  ${GREEN}Last Log: $LAST_LOG_DATE ($DAYS_SINCE_LOG days ago)${NC}"
                        echo "  Log Count: $LOG_COUNT"
                    fi
                fi
            fi
        fi
        
        # Check Azure Monitor Metrics
        echo "  Checking metrics..."
        
        # Get available metrics for this resource type
        METRICS=$(az monitor metrics list-definitions --resource "$RES_ID" -o json 2>/dev/null || echo "[]")
        
        if [ "$(echo "$METRICS" | jq '. | length')" -gt 0 ]; then
            # Get the first available metric
            METRIC_NAME=$(echo "$METRICS" | jq -r '.[0].name.value' 2>/dev/null || echo "")
            
            if [ -n "$METRIC_NAME" ] && [ "$METRIC_NAME" != "null" ]; then
                # Query metric data for last 90 days
                METRIC_DATA=$(az monitor metrics list \
                    --resource "$RES_ID" \
                    --metric "$METRIC_NAME" \
                    --start-time "$(date -u -d '90 days ago' '+%Y-%m-%dT%H:%M:%SZ')" \
                    --end-time "$(date -u '+%Y-%m-%dT%H:%M:%SZ')" \
                    --interval PT1H \
                    -o json 2>/dev/null || echo '{"value":[]}')
                
                # Check if there's recent metric data
                TIMESERIES=$(echo "$METRIC_DATA" | jq -r '.value[0].timeseries[0].data // [] | map(select(.total != null or .average != null or .count != null)) | sort_by(.timeStamp) | reverse | .[0].timeStamp // empty' 2>/dev/null || echo "")
                
                if [ -n "$TIMESERIES" ]; then
                    LAST_METRIC_DATE="$TIMESERIES"
                    HAS_RECENT_METRICS="Yes"
                    
                    LAST_METRIC_EPOCH=$(date -d "$LAST_METRIC_DATE" +%s 2>/dev/null || echo "0")
                    CURRENT_EPOCH=$(date +%s)
                    DAYS_SINCE_METRIC=$((( CURRENT_EPOCH - LAST_METRIC_EPOCH ) / 86400))
                    
                    echo -e "  ${GREEN}Last Metric: $LAST_METRIC_DATE ($DAYS_SINCE_METRIC days ago)${NC}"
                fi
            fi
        fi
        
        # Determine overall status
        if [ "$DAYS_SINCE_LOG" != "N/A" ] && [ $DAYS_SINCE_LOG -le $DAYS_TO_CHECK ]; then
            STATUS="ACTIVE"
            ACTIVE_RESOURCES=$((ACTIVE_RESOURCES + 1))
            echo -e "  ${GREEN}Status: ACTIVE${NC}"
        elif [ "$DAYS_SINCE_METRIC" != "N/A" ] && [ $DAYS_SINCE_METRIC -le $DAYS_TO_CHECK ]; then
            STATUS="ACTIVE"
            ACTIVE_RESOURCES=$((ACTIVE_RESOURCES + 1))
            echo -e "  ${GREEN}Status: ACTIVE (Metrics only)${NC}"
        elif [ "$DAYS_SINCE_LOG" != "N/A" ] || [ "$DAYS_SINCE_METRIC" != "N/A" ]; then
            STATUS="INACTIVE"
            INACTIVE_RESOURCES=$((INACTIVE_RESOURCES + 1))
            echo -e "  ${RED}Status: INACTIVE${NC}"
        else
            STATUS="NO_DATA"
            NO_DATA_RESOURCES=$((NO_DATA_RESOURCES + 1))
            echo -e "  ${RED}Status: NO DATA${NC}"
        fi
        
        # Write to CSV
        echo "$SUB_NAME,$SUB_ID,$RES_NAME,$RES_TYPE,$RES_RG,$RES_LOCATION,$WORKSPACE_FOUND,$LAST_LOG_DATE,$DAYS_SINCE_LOG,$HAS_RECENT_METRICS,$LAST_METRIC_DATE,$DAYS_SINCE_METRIC,$STATUS,$RES_TAGS" >> "$OUTPUT_FILE"
        
        echo ""
    done
    
    echo ""
    
done < "$TEMP_DIR/subscriptions.txt"

# Cleanup
rm -rf "$TEMP_DIR"

# Final Summary
echo "========================================================="
echo "Audit Complete!"
echo "========================================================="
echo "Total Subscriptions: $TOTAL_SUBS"
echo "Total Resources Checked: $TOTAL_RESOURCES"
echo ""
echo -e "${GREEN}Active Resources (activity < $DAYS_TO_CHECK days): $ACTIVE_RESOURCES${NC}"
echo -e "${YELLOW}Inactive Resources (activity > $DAYS_TO_CHECK days): $INACTIVE_RESOURCES${NC}"
echo -e "${RED}No Data Resources: $NO_DATA_RESOURCES${NC}"
echo ""
echo "Results saved to: $OUTPUT_FILE"
echo ""

# Summary by resource type
if [ -f "$OUTPUT_FILE" ]; then
    echo "Inactive Resources by Type:"
    echo "============================"
    awk -F',' 'NR>1 && ($13=="INACTIVE" || $13=="NO_DATA") {print $4}' "$OUTPUT_FILE" | sort | uniq -c | sort -rn | head -20
    
    echo ""
    echo "Top 20 Inactive Resources:"
    echo "=========================="
    awk -F',' 'NR>1 && ($13=="INACTIVE" || $13=="NO_DATA") {printf "  - %s (%s) - RG: %s - Days: %s\n", $3, $4, $5, $9}' "$OUTPUT_FILE" | head -20
fi
