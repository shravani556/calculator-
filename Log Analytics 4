#!/bin/bash

# Script to evaluate Log Analytics Workspaces usage in both Legacy and vNext
# Identifies workspaces with no activity in the past 90 days

set -e

# Configuration
DAYS_TO_CHECK=90
OUTPUT_FILE="log_analytics_audit_$(date +%Y%m%d_%H%M%S).csv"
TEMP_FILE="/tmp/law_audit_$$.json"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "========================================"
echo "Log Analytics Workspace Audit Script"
echo "========================================"
echo "Checking for workspaces with no activity in the past $DAYS_TO_CHECK days"
echo ""

# Check if Azure CLI is installed
if ! command -v az &> /dev/null; then
    echo -e "${RED}Error: Azure CLI is not installed${NC}"
    exit 1
fi

# Check if logged in
if ! az account show &> /dev/null; then
    echo -e "${RED}Error: Not logged into Azure. Please run 'az login'${NC}"
    exit 1
fi

# Get current subscription
SUBSCRIPTION=$(az account show --query name -o tsv)
echo "Current subscription: $SUBSCRIPTION"
echo ""

# Create CSV header
echo "WorkspaceName,ResourceGroup,Location,Type,ProvisioningState,RetentionDays,LastLogEntry,DaysSinceLastLog,Status" > "$OUTPUT_FILE"

# Get all Log Analytics Workspaces
echo "Fetching all Log Analytics Workspaces..."
az monitor log-analytics workspace list -o json > "$TEMP_FILE"

TOTAL_WORKSPACES=$(jq '. | length' "$TEMP_FILE")
echo "Found $TOTAL_WORKSPACES workspaces"
echo ""

INACTIVE_COUNT=0
ACTIVE_COUNT=0
COUNTER=0

# Process each workspace
jq -c '.[]' "$TEMP_FILE" | while read -r workspace; do
    COUNTER=$((COUNTER + 1))
    
    WS_NAME=$(echo "$workspace" | jq -r '.name')
    WS_RG=$(echo "$workspace" | jq -r '.resourceGroup')
    WS_LOCATION=$(echo "$workspace" | jq -r '.location')
    WS_STATE=$(echo "$workspace" | jq -r '.provisioningState')
    WS_RETENTION=$(echo "$workspace" | jq -r '.retentionInDays // "N/A"')
    WS_ID=$(echo "$workspace" | jq -r '.id')
    
    # Determine workspace type (Legacy vs vNext)
    WS_TYPE="Legacy"
    if echo "$workspace" | jq -e '.properties.features.enableLogAccessUsingOnlyResourcePermissions == true' &> /dev/null; then
        WS_TYPE="vNext"
    fi
    
    echo -e "${YELLOW}[$COUNTER/$TOTAL_WORKSPACES] Checking: $WS_NAME ($WS_TYPE)${NC}"
    
    # Query for last log entry in the workspace
    QUERY="union withsource=TableName *
    | summarize LastLog=max(TimeGenerated)
    | project LastLog"
    
    # Execute query with error handling
    LAST_LOG=$(az monitor log-analytics query \
        -w "$WS_ID" \
        --analytics-query "$QUERY" \
        --timespan "PT720H" \
        -o json 2>/dev/null | jq -r '.[0].LastLog // "Never"' || echo "Never")
    
    # Calculate days since last log
    if [ "$LAST_LOG" != "Never" ] && [ "$LAST_LOG" != "null" ]; then
        LAST_LOG_EPOCH=$(date -d "$LAST_LOG" +%s 2>/dev/null || echo "0")
        CURRENT_EPOCH=$(date +%s)
        DAYS_SINCE=$((( CURRENT_EPOCH - LAST_LOG_EPOCH ) / 86400))
        
        if [ $DAYS_SINCE -gt $DAYS_TO_CHECK ]; then
            STATUS="INACTIVE"
            INACTIVE_COUNT=$((INACTIVE_COUNT + 1))
            echo -e "${RED}  ✗ INACTIVE: No logs for $DAYS_SINCE days${NC}"
        else
            STATUS="ACTIVE"
            ACTIVE_COUNT=$((ACTIVE_COUNT + 1))
            echo -e "${GREEN}  ✓ ACTIVE: Last log $DAYS_SINCE days ago${NC}"
        fi
    else
        DAYS_SINCE="Unknown"
        STATUS="NO_DATA"
        INACTIVE_COUNT=$((INACTIVE_COUNT + 1))
        echo -e "${RED}  ✗ NO DATA: No logs found${NC}"
    fi
    
    # Write to CSV
    echo "$WS_NAME,$WS_RG,$WS_LOCATION,$WS_TYPE,$WS_STATE,$WS_RETENTION,$LAST_LOG,$DAYS_SINCE,$STATUS" >> "$OUTPUT_FILE"
    echo ""
done

# Cleanup
rm -f "$TEMP_FILE"

# Summary
echo "========================================"
echo "Audit Complete!"
echo "========================================"
echo "Total Workspaces: $TOTAL_WORKSPACES"
echo -e "${GREEN}Active Workspaces: $ACTIVE_COUNT${NC}"
echo -e "${RED}Inactive Workspaces: $INACTIVE_COUNT${NC}"
echo ""
echo "Results saved to: $OUTPUT_FILE"
echo ""
echo "Inactive workspaces (no logs in past $DAYS_TO_CHECK days):"
awk -F',' '$9 == "INACTIVE" || $9 == "NO_DATA" {print "  - " $1 " (" $4 ") - " $8 " days"}' "$OUTPUT_FILE"
