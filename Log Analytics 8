#!/bin/bash

# Log Analytics Workspace - Connected Resources Usage Audit
# Shows which resources are sending logs to LAW and if they're actually in use

set -e

OUTPUT_FILE="law_connected_resources_audit_$(date +%Y%m%d_%H%M%S).csv"
TEMP_DIR="/tmp/law_resources_audit_$$"
mkdir -p "$TEMP_DIR"

DAYS_TO_CHECK=90

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo "========================================================================="
echo "Log Analytics Workspace - Connected Resources Usage Audit"
echo "========================================================================="
echo "Checking which resources send logs to LAW and their last activity"
echo ""

# Check prerequisites
if ! command -v az &> /dev/null; then
    echo -e "${RED}Error: Azure CLI is not installed${NC}"
    exit 1
fi

if ! az account show &> /dev/null; then
    echo -e "${RED}Error: Not logged into Azure${NC}"
    exit 1
fi

# CSV Header
echo "SubscriptionName,SubscriptionId,WorkspaceName,WorkspaceResourceGroup,ConnectedResourceName,ConnectedResourceType,ConnectedResourceGroup,LastLogDate,DaysSinceLastLog,TotalLogEntries,UsageStatus,Recommendation" > "$OUTPUT_FILE"

# Get all enabled subscriptions
echo "Fetching all subscriptions..."
az account list --query "[?state=='Enabled'].[name,id]" -o tsv > "$TEMP_DIR/subscriptions.txt"

TOTAL_SUBS=$(wc -l < "$TEMP_DIR/subscriptions.txt")
echo -e "${CYAN}Found $TOTAL_SUBS enabled subscription(s)${NC}"
echo ""

TOTAL_WORKSPACES=0
TOTAL_RESOURCES=0
IN_USE_RESOURCES=0
IDLE_RESOURCES=0
UNUSED_RESOURCES=0

# Process each subscription
while IFS=$'\t' read -r SUB_NAME SUB_ID; do
    echo "========================================================================="
    echo -e "${BLUE}Subscription: $SUB_NAME${NC}"
    echo "========================================================================="
    
    az account set --subscription "$SUB_ID" 2>/dev/null || continue
    
    # Get all Log Analytics Workspaces
    echo "Fetching Log Analytics Workspaces..."
    az monitor log-analytics workspace list -o json > "$TEMP_DIR/workspaces.json" 2>/dev/null || echo "[]" > "$TEMP_DIR/workspaces.json"
    
    WS_COUNT=$(jq '. | length' "$TEMP_DIR/workspaces.json")
    
    if [ "$WS_COUNT" -eq 0 ]; then
        echo "No Log Analytics Workspaces found in this subscription"
        echo ""
        continue
    fi
    
    echo -e "${CYAN}Found $WS_COUNT workspace(s)${NC}"
    echo ""
    
    TOTAL_WORKSPACES=$((TOTAL_WORKSPACES + WS_COUNT))
    
    # Process each workspace
    jq -c '.[]' "$TEMP_DIR/workspaces.json" | while read -r workspace; do
        WS_NAME=$(echo "$workspace" | jq -r '.name')
        WS_ID=$(echo "$workspace" | jq -r '.id')
        WS_RG=$(echo "$workspace" | jq -r '.resourceGroup')
        WS_CUSTOMER_ID=$(echo "$workspace" | jq -r '.customerId')
        
        echo "-------------------------------------------------------------------------"
        echo -e "${YELLOW}Workspace: $WS_NAME${NC}"
        echo "Resource Group: $WS_RG"
        echo "-------------------------------------------------------------------------"
        
        # Query to find all resources that have sent logs to this workspace
        RESOURCES_QUERY="search *
        | where TimeGenerated > ago(365d)
        | where _ResourceId != \"\"
        | summarize 
            LastLog = max(TimeGenerated),
            TotalLogs = count()
            by _ResourceId
        | extend ResourceName = tostring(split(_ResourceId, '/')[8])
        | extend ResourceType = strcat(tostring(split(_ResourceId, '/')[6]), '/', tostring(split(_ResourceId, '/')[7]))
        | extend ResourceGroup = tostring(split(_ResourceId, '/')[4])
        | project _ResourceId, ResourceName, ResourceType, ResourceGroup, LastLog, TotalLogs
        | order by LastLog desc"
        
        echo "Querying for connected resources..."
        
        RESOURCES_RESULT=$(az monitor log-analytics query \
            -w "$WS_ID" \
            --analytics-query "$RESOURCES_QUERY" \
            -o json 2>/dev/null || echo "[]")
        
        RESOURCE_COUNT=$(echo "$RESOURCES_RESULT" | jq '. | length')
        
        if [ "$RESOURCE_COUNT" -eq 0 ]; then
            echo -e "${RED}No resources found sending logs to this workspace${NC}"
            echo ""
            continue
        fi
        
        echo -e "${CYAN}Found $RESOURCE_COUNT resource(s) sending logs to this workspace${NC}"
        echo ""
        
        TOTAL_RESOURCES=$((TOTAL_RESOURCES + RESOURCE_COUNT))
        
        # Process each resource
        echo "$RESOURCES_RESULT" | jq -c '.[]' | while read -r resource; do
            RESOURCE_ID=$(echo "$resource" | jq -r '._ResourceId')
            RESOURCE_NAME=$(echo "$resource" | jq -r '.ResourceName')
            RESOURCE_TYPE=$(echo "$resource" | jq -r '.ResourceType')
            RESOURCE_RG=$(echo "$resource" | jq -r '.ResourceGroup')
            LAST_LOG=$(echo "$resource" | jq -r '.LastLog')
            TOTAL_LOGS=$(echo "$resource" | jq -r '.TotalLogs')
            
            echo -e "  ${YELLOW}Resource: $RESOURCE_NAME${NC}"
            echo "    Type: $RESOURCE_TYPE"
            echo "    Resource Group: $RESOURCE_RG"
            echo "    Total Log Entries: $TOTAL_LOGS"
            
            # Calculate days since last log
            DAYS_SINCE="N/A"
            USAGE_STATUS="UNKNOWN"
            RECOMMENDATION="Review needed"
            
            if [ "$LAST_LOG" != "null" ] && [ "$LAST_LOG" != "" ]; then
                LAST_LOG_EPOCH=$(date -d "$LAST_LOG" +%s 2>/dev/null || echo "0")
                CURRENT_EPOCH=$(date +%s)
                DAYS_SINCE=$((( CURRENT_EPOCH - LAST_LOG_EPOCH ) / 86400))
                
                echo "    Last Log: $LAST_LOG ($DAYS_SINCE days ago)"
                
                if [ $DAYS_SINCE -le $DAYS_TO_CHECK ]; then
                    USAGE_STATUS="IN_USE"
                    RECOMMENDATION="Keep monitoring - Resource actively logging"
                    IN_USE_RESOURCES=$((IN_USE_RESOURCES + 1))
                    echo -e "    ${GREEN}✓ IN USE - Active logging (last $DAYS_SINCE days)${NC}"
                elif [ $DAYS_SINCE -le 180 ]; then
                    USAGE_STATUS="IDLE"
                    RECOMMENDATION="Review - No logs for $DAYS_SINCE days, may be inactive"
                    IDLE_RESOURCES=$((IDLE_RESOURCES + 1))
                    echo -e "    ${YELLOW}⚠ IDLE - No recent logs (last $DAYS_SINCE days)${NC}"
                else
                    USAGE_STATUS="UNUSED"
                    RECOMMENDATION="Consider removing diagnostic settings - No logs for $DAYS_SINCE days"
                    UNUSED_RESOURCES=$((UNUSED_RESOURCES + 1))
                    echo -e "    ${RED}✗ UNUSED - No logs for $DAYS_SINCE days${NC}"
                fi
            else
                USAGE_STATUS="NO_DATA"
                RECOMMENDATION="Check diagnostic settings"
                UNUSED_RESOURCES=$((UNUSED_RESOURCES + 1))
                echo -e "    ${RED}✗ NO DATA${NC}"
            fi
            
            # Write to CSV
            echo "$SUB_NAME,$SUB_ID,$WS_NAME,$WS_RG,$RESOURCE_NAME,$RESOURCE_TYPE,$RESOURCE_RG,$LAST_LOG,$DAYS_SINCE,$TOTAL_LOGS,$USAGE_STATUS,$RECOMMENDATION" >> "$OUTPUT_FILE"
            echo ""
        done
        
        echo ""
    done
    
    echo ""
    
done < "$TEMP_DIR/subscriptions.txt"

# Cleanup
rm -rf "$TEMP_DIR"

# Final Summary
echo "========================================================================="
echo "Audit Complete!"
echo "========================================================================="
echo "Total Subscriptions Checked: $TOTAL_SUBS"
echo "Total Workspaces Found: $TOTAL_WORKSPACES"
echo "Total Resources Connected to Workspaces: $TOTAL_RESOURCES"
echo ""
echo -e "${GREEN}Resources IN USE (logs < $DAYS_TO_CHECK days): $IN_USE_RESOURCES${NC}"
echo -e "${YELLOW}Resources IDLE (logs 90-180 days old): $IDLE_RESOURCES${NC}"
echo -e "${RED}Resources UNUSED (logs > 180 days or none): $UNUSED_RESOURCES${NC}"
echo ""
echo "Results saved to: $OUTPUT_FILE"
echo ""

# Show top unused resources
if [ -f "$OUTPUT_FILE" ]; then
    echo "Top Resources Not Sending Logs (Unused/Idle):"
    echo "=============================================="
    awk -F',' 'NR>1 && ($11=="UNUSED" || $11=="IDLE") {printf "  - %s (%s) in workspace %s - Last log: %s days ago\n", $5, $6, $3, $9}' "$OUTPUT_FILE" | head -30
    echo ""
    echo "Summary by Workspace:"
    echo "====================="
    awk -F',' 'NR>1 {ws[$3]++; if($11=="IN_USE") active[$3]++; if($11=="UNUSED") unused[$3]++} 
    END {for(w in ws) printf "  %s: Total=%d, Active=%d, Unused=%d\n", w, ws[w], active[w]+0, unused[w]+0}' "$OUTPUT_FILE"
fi
