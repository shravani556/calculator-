#!/bin/bash

# Log Analytics Workspace Activity Analyzer - All Subscriptions
# This script checks ALL Azure subscriptions for Log Analytics workspaces
# Generates a CSV file with detailed information including costs

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Generate timestamp for filename
TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
OUTPUT_FILE="LAW_Final_Report_${TIMESTAMP}.csv"

# Check if Azure CLI is installed
if ! command -v az &> /dev/null; then
    echo -e "${RED}Error: Azure CLI is not installed${NC}"
    echo "Please install it from: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli"
    exit 1
fi

# Check if logged in
if ! az account show &> /dev/null; then
    echo -e "${RED}Error: Not logged in to Azure${NC}"
    echo "Please run: az login"
    exit 1
fi

echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║  Log Analytics Workspace Activity Report - All Subscriptions  ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}\n"

# Calculate dates
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    START_DATE=$(date -u -v-90d '+%Y-%m-%dT%H:%M:%SZ')
    NOV_START="2024-11-01T00:00:00Z"
    NOV_END="2024-11-30T23:59:59Z"
else
    # Linux
    START_DATE=$(date -u -d '90 days ago' '+%Y-%m-%dT%H:%M:%SZ')
    NOV_START="2024-11-01T00:00:00Z"
    NOV_END="2024-11-30T23:59:59Z"
fi

END_DATE=$(date -u '+%Y-%m-%dT%H:%M:%SZ')

echo -e "${YELLOW}📅 Analysis Period:${NC}"
echo "   • Last 90 days: ${START_DATE} to ${END_DATE}"
echo "   • Cost analysis: November 2024"
echo ""

# Get all subscriptions
echo -e "${CYAN}🔍 Discovering subscriptions...${NC}\n"
SUBSCRIPTIONS=$(az account list --query "[?state=='Enabled'].{id:id,name:name}" -o json)

if [ -z "$SUBSCRIPTIONS" ] || [ "$SUBSCRIPTIONS" == "[]" ]; then
    echo -e "${RED}No enabled subscriptions found${NC}"
    exit 1
fi

SUB_COUNT=$(echo "$SUBSCRIPTIONS" | jq length)
echo -e "${GREEN}✓ Found ${SUB_COUNT} enabled subscription(s)${NC}\n"

# Display all subscriptions
echo -e "${CYAN}Subscriptions to analyze:${NC}"
echo "$SUBSCRIPTIONS" | jq -r '.[] | "  • \(.name) (\(.id))"'
echo ""

# Create CSV header
echo "SubscriptionName,SubscriptionID,WorkspaceName,ResourceGroup,Location,WorkspaceID,SKU,RetentionDays,DailyCap(GB),LastLogDate,DaysActiveIn90Days,ActivityPercentage,TotalRecordsLast90Days,DataIngested90Days(GB),NovemberCost(USD),TopTable1,TopTable1Records,TopTable2,TopTable2Records,TopTable3,TopTable3Records,Status" > "$OUTPUT_FILE"

TOTAL_WORKSPACES=0
TOTAL_ACTIVE=0
TOTAL_INACTIVE=0

# Loop through each subscription
echo "$SUBSCRIPTIONS" | jq -c '.[]' | while read -r subscription; do
    SUB_NAME=$(echo "$subscription" | jq -r '.name')
    SUB_ID=$(echo "$subscription" | jq -r '.id')
    
    echo -e "${MAGENTA}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${MAGENTA}║  Subscription: ${SUB_NAME}${NC}"
    echo -e "${MAGENTA}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Set subscription context
    az account set --subscription "$SUB_ID" 2>/dev/null
    
    echo -e "${CYAN}🔎 Searching for Log Analytics workspaces...${NC}"
    
    # Get all Log Analytics workspaces in this subscription
    WORKSPACES=$(az monitor log-analytics workspace list -o json 2>/dev/null || echo "[]")
    
    if [ "$WORKSPACES" == "[]" ] || [ -z "$WORKSPACES" ]; then
        echo -e "${YELLOW}⚠ No Log Analytics workspaces found in this subscription${NC}\n"
        echo "\"$SUB_NAME\",\"$SUB_ID\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",0,0,0,0,0,\"N/A\",0,\"N/A\",0,\"N/A\",0,\"No workspaces\"" >> "$OUTPUT_FILE"
        continue
    fi
    
    WORKSPACE_COUNT=$(echo "$WORKSPACES" | jq length)
    echo -e "${GREEN}✓ Found ${WORKSPACE_COUNT} workspace(s)${NC}\n"
    
    TOTAL_WORKSPACES=$((TOTAL_WORKSPACES + WORKSPACE_COUNT))
    
    CURRENT=0
    
    # Process each workspace
    echo "$WORKSPACES" | jq -c '.[]' | while read -r workspace; do
        CURRENT=$((CURRENT + 1))
        
        WORKSPACE_NAME=$(echo "$workspace" | jq -r '.name')
        RESOURCE_GROUP=$(echo "$workspace" | jq -r '.resourceGroup')
        LOCATION=$(echo "$workspace" | jq -r '.location')
        WORKSPACE_ID=$(echo "$workspace" | jq -r '.id')
        WORKSPACE_RESOURCE_ID=$(echo "$workspace" | jq -r '.id')
        SKU=$(echo "$workspace" | jq -r '.sku.name // "N/A"')
        RETENTION=$(echo "$workspace" | jq -r '.retentionInDays // "N/A"')
        DAILY_CAP=$(echo "$workspace" | jq -r '.workspaceCapping.dailyQuotaGb // "N/A"')
        
        echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GREEN}[$CURRENT/$WORKSPACE_COUNT] Workspace: ${WORKSPACE_NAME}${NC}"
        echo -e "  📍 Resource Group: ${RESOURCE_GROUP}"
        echo -e "  🌍 Location: ${LOCATION}"
        echo -e "  💳 SKU: ${SKU}"
        echo -e "  📦 Retention: ${RETENTION} days"
        echo -e "  📊 Daily Cap: ${DAILY_CAP} GB"
        echo ""
        
        # Initialize variables
        LAST_LOG_DATE="No logs"
        DAYS_COUNT="0"
        PERCENTAGE="0.0"
        TOTAL_RECORDS="0"
        DATA_INGESTED="0"
        NOV_COST="0.00"
        STATUS="Inactive"
        TABLE1="N/A"
        TABLE1_COUNT="0"
        TABLE2="N/A"
        TABLE2_COUNT="0"
        TABLE3="N/A"
        TABLE3_COUNT="0"
        
        # Query for last log entry and total records (90 days)
        SUMMARY_QUERY="union withsource=TableName *
| where TimeGenerated >= ago(90d)
| summarize LastLog = max(TimeGenerated), TotalRecords = count()"
        
        echo "  🔍 Querying workspace data..."
        SUMMARY=$(az monitor log-analytics query -w "$WORKSPACE_RESOURCE_ID" --analytics-query "$SUMMARY_QUERY" -o json 2>/dev/null || echo "[]")
        
        if [ "$SUMMARY" != "[]" ] && [ "$(echo "$SUMMARY" | jq length)" -gt 0 ]; then
            LAST_LOG_DATE=$(echo "$SUMMARY" | jq -r '.[0].LastLog // "No logs"' 2>/dev/null)
            TOTAL_RECORDS=$(echo "$SUMMARY" | jq -r '.[0].TotalRecords // "0"' 2>/dev/null)
            
            if [ "$LAST_LOG_DATE" != "null" ] && [ "$LAST_LOG_DATE" != "No logs" ] && [ -n "$LAST_LOG_DATE" ]; then
                echo -e "  ${GREEN}✓ Last Log: ${LAST_LOG_DATE}${NC}"
                echo -e "  ${GREEN}✓ Total Records (90d): ${TOTAL_RECORDS}${NC}"
                STATUS="Active"
            else
                LAST_LOG_DATE="No logs"
                echo -e "  ${YELLOW}⚠ No logs in past 90 days${NC}"
            fi
        else
            echo -e "  ${YELLOW}⚠ No logs in past 90 days${NC}"
        fi
        
        # Query for active days
        if [ "$STATUS" == "Active" ]; then
            ACTIVE_DAYS_QUERY="union withsource=TableName *
| where TimeGenerated >= ago(90d)
| summarize by bin(TimeGenerated, 1d)
| count"
            
            echo "  📅 Calculating active days..."
            ACTIVE_DAYS=$(az monitor log-analytics query -w "$WORKSPACE_RESOURCE_ID" --analytics-query "$ACTIVE_DAYS_QUERY" -o json 2>/dev/null || echo "[]")
            
            if [ "$ACTIVE_DAYS" != "[]" ] && [ "$(echo "$ACTIVE_DAYS" | jq length)" -gt 0 ]; then
                DAYS_COUNT=$(echo "$ACTIVE_DAYS" | jq -r '.[0].Count // "0"' 2>/dev/null)
                
                if [ "$DAYS_COUNT" != "null" ] && [ -n "$DAYS_COUNT" ] && [ "$DAYS_COUNT" != "0" ]; then
                    PERCENTAGE=$(echo "scale=2; ($DAYS_COUNT / 90) * 100" | bc 2>/dev/null || echo "0.00")
                    echo -e "  ${GREEN}✓ Active Days: ${DAYS_COUNT}/90 (${PERCENTAGE}%)${NC}"
                fi
            fi
            
            # Query for data ingestion in last 90 days (in GB)
            DATA_QUERY="Usage
| where TimeGenerated >= ago(90d)
| where IsBillable == true
| summarize TotalGB = sum(Quantity) / 1000"
            
            echo "  💾 Calculating data ingestion..."
            DATA_RESULT=$(az monitor log-analytics query -w "$WORKSPACE_RESOURCE_ID" --analytics-query "$DATA_QUERY" -o json 2>/dev/null || echo "[]")
            
            if [ "$DATA_RESULT" != "[]" ] && [ "$(echo "$DATA_RESULT" | jq length)" -gt 0 ]; then
                DATA_INGESTED=$(echo "$DATA_RESULT" | jq -r '.[0].TotalGB // "0"' 2>/dev/null)
                if [ "$DATA_INGESTED" != "null" ] && [ -n "$DATA_INGESTED" ]; then
                    DATA_INGESTED=$(printf "%.2f" "$DATA_INGESTED" 2>/dev/null || echo "0")
                    echo -e "  ${GREEN}✓ Data Ingested (90d): ${DATA_INGESTED} GB${NC}"
                fi
            fi
            
            # Query for November 2024 cost estimation
            NOV_COST_QUERY="Usage
| where TimeGenerated between (datetime(2024-11-01) .. datetime(2024-11-30))
| where IsBillable == true
| summarize TotalGB = sum(Quantity) / 1000"
            
            echo "  💰 Calculating November 2024 cost..."
            NOV_DATA=$(az monitor log-analytics query -w "$WORKSPACE_RESOURCE_ID" --analytics-query "$NOV_COST_QUERY" -o json 2>/dev/null || echo "[]")
            
            if [ "$NOV_DATA" != "[]" ] && [ "$(echo "$NOV_DATA" | jq length)" -gt 0 ]; then
                NOV_GB=$(echo "$NOV_DATA" | jq -r '.[0].TotalGB // "0"' 2>/dev/null)
                if [ "$NOV_GB" != "null" ] && [ -n "$NOV_GB" ] && [ "$NOV_GB" != "0" ]; then
                    # Estimate cost: Pay-as-you-go is ~$2.76/GB (varies by region/SKU)
                    # Using $2.76 as average, adjust based on actual pricing
                    NOV_COST=$(echo "scale=2; $NOV_GB * 2.76" | bc 2>/dev/null || echo "0.00")
                    echo -e "  ${GREEN}✓ November Data: ${NOV_GB} GB${NC}"
                    echo -e "  ${GREEN}✓ Estimated Cost: \$${NOV_COST} USD${NC}"
                fi
            else
                echo -e "  ${YELLOW}⚠ No November data available${NC}"
            fi
            
            # Get top 3 tables
            TOP_TABLES_QUERY="union withsource=TableName *
| where TimeGenerated >= ago(90d)
| summarize RecordCount = count() by TableName
| top 3 by RecordCount desc"
            
            echo "  📋 Fetching top tables..."
            TOP_TABLES=$(az monitor log-analytics query -w "$WORKSPACE_RESOURCE_ID" --analytics-query "$TOP_TABLES_QUERY" -o json 2>/dev/null || echo "[]")
            
            if [ "$TOP_TABLES" != "[]" ] && [ "$(echo "$TOP_TABLES" | jq length)" -gt 0 ]; then
                TABLE1=$(echo "$TOP_TABLES" | jq -r '.[0].TableName // "N/A"' 2>/dev/null)
                TABLE1_COUNT=$(echo "$TOP_TABLES" | jq -r '.[0].RecordCount // "0"' 2>/dev/null)
                TABLE2=$(echo "$TOP_TABLES" | jq -r '.[1].TableName // "N/A"' 2>/dev/null)
                TABLE2_COUNT=$(echo "$TOP_TABLES" | jq -r '.[1].RecordCount // "0"' 2>/dev/null)
                TABLE3=$(echo "$TOP_TABLES" | jq -r '.[2].TableName // "N/A"' 2>/dev/null)
                TABLE3_COUNT=$(echo "$TOP_TABLES" | jq -r '.[2].RecordCount // "0"' 2>/dev/null)
                
                echo -e "  ${BLUE}Top 3 Tables:${NC}"
                [ "$TABLE1" != "N/A" ] && echo -e "    1️⃣  ${TABLE1}: ${TABLE1_COUNT} records"
                [ "$TABLE2" != "N/A" ] && echo -e "    2️⃣  ${TABLE2}: ${TABLE2_COUNT} records"
                [ "$TABLE3" != "N/A" ] && echo -e "    3️⃣  ${TABLE3}: ${TABLE3_COUNT} records"
            fi
        fi
        
        # Write to CSV
        echo "\"$SUB_NAME\",\"$SUB_ID\",\"$WORKSPACE_NAME\",\"$RESOURCE_GROUP\",\"$LOCATION\",\"$WORKSPACE_RESOURCE_ID\",\"$SKU\",\"$RETENTION\",\"$DAILY_CAP\",\"$LAST_LOG_DATE\",$DAYS_COUNT,$PERCENTAGE,$TOTAL_RECORDS,$DATA_INGESTED,$NOV_COST,\"$TABLE1\",$TABLE1_COUNT,\"$TABLE2\",$TABLE2_COUNT,\"$TABLE3\",$TABLE3_COUNT,\"$STATUS\"" >> "$OUTPUT_FILE"
        
        echo ""
    done
    
    echo ""
done

echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║              ANALYSIS COMPLETE                             ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}\n"

echo -e "${CYAN}📊 Summary:${NC}"
echo "  • Total Subscriptions: $SUB_COUNT"
echo "  • Report File: $OUTPUT_FILE"
echo "  • Date: $(date)"
echo ""
echo -e "${GREEN}✅ CSV file ready! Open in Excel or any spreadsheet application${NC}"
echo ""
