#!/bin/bash

# Azure Resources USAGE Audit - Checks actual utilization, not just activity
# Determines if resources are being USED vs just running idle

set -e

OUTPUT_FILE="azure_resources_usage_audit_$(date +%Y%m%d_%H%M%S).csv"
TEMP_DIR="/tmp/usage_audit_$$"
mkdir -p "$TEMP_DIR"

DAYS_TO_CHECK=90

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

echo "========================================================="
echo "Azure Resources USAGE Audit - Actual Utilization Check"
echo "========================================================="
echo "Checking if resources are actually USED (not just running)"
echo ""

# Check prerequisites
if ! command -v az &> /dev/null; then
    echo -e "${RED}Error: Azure CLI is not installed${NC}"
    exit 1
fi

if ! az account show &> /dev/null; then
    echo -e "${RED}Error: Not logged into Azure${NC}"
    exit 1
fi

# CSV Header
echo "SubscriptionName,SubscriptionId,ResourceName,ResourceType,ResourceGroup,Location,IsRunning,ActualUsageIndicator,LastUsedDate,DaysSinceUsed,AvgCPU%,AvgMemory%,NetworkIn/Out,UsageStatus,Recommendation,MonthlyCost" > "$OUTPUT_FILE"

# Get all enabled subscriptions
echo "Fetching all subscriptions..."
az account list --query "[?state=='Enabled'].[name,id]" -o tsv > "$TEMP_DIR/subscriptions.txt"

TOTAL_SUBS=$(wc -l < "$TEMP_DIR/subscriptions.txt")
echo -e "${CYAN}Found $TOTAL_SUBS enabled subscription(s)${NC}"
echo ""

TOTAL_RESOURCES=0
IN_USE=0
IDLE=0
UNUSED=0

# Process each subscription
while IFS=$'\t' read -r SUB_NAME SUB_ID; do
    echo "============================================================"
    echo -e "${BLUE}Subscription: $SUB_NAME${NC}"
    echo "============================================================"
    
    az account set --subscription "$SUB_ID" 2>/dev/null || continue
    
    echo "Analyzing Virtual Machines..."
    echo "------------------------------------------------------------"
    
    # Get all VMs
    az vm list -d --query "[].{name:name,id:id,rg:resourceGroup,powerState:powerState,size:hardwareProfile.vmSize}" -o json > "$TEMP_DIR/vms.json" 2>/dev/null || echo "[]" > "$TEMP_DIR/vms.json"
    
    VM_COUNT=$(jq '. | length' "$TEMP_DIR/vms.json")
    
    if [ $VM_COUNT -gt 0 ]; then
        jq -c '.[]' "$TEMP_DIR/vms.json" | while read -r vm; do
            TOTAL_RESOURCES=$((TOTAL_RESOURCES + 1))
            
            VM_NAME=$(echo "$vm" | jq -r '.name')
            VM_ID=$(echo "$vm" | jq -r '.id')
            VM_RG=$(echo "$vm" | jq -r '.rg')
            VM_STATE=$(echo "$vm" | jq -r '.powerState')
            VM_SIZE=$(echo "$vm" | jq -r '.size')
            
            echo -e "${YELLOW}Checking VM: $VM_NAME${NC}"
            echo "  Power State: $VM_STATE"
            echo "  Size: $VM_SIZE"
            
            IS_RUNNING="No"
            USAGE_INDICATOR="N/A"
            LAST_USED="Never"
            DAYS_SINCE_USED="N/A"
            AVG_CPU="0"
            AVG_MEMORY="0"
            NETWORK_IO="0/0"
            USAGE_STATUS="UNUSED"
            RECOMMENDATION="Consider deallocating"
            MONTHLY_COST="Unknown"
            
            if [[ "$VM_STATE" == *"running"* ]]; then
                IS_RUNNING="Yes"
                echo "  Status: Running - Checking actual usage..."
                
                # Get CPU usage for last 90 days
                CPU_DATA=$(az monitor metrics list \
                    --resource "$VM_ID" \
                    --metric "Percentage CPU" \
                    --start-time "$(date -u -d "$DAYS_TO_CHECK days ago" '+%Y-%m-%dT%H:%M:%SZ')" \
                    --interval PT1H \
                    --aggregation Average \
                    -o json 2>/dev/null || echo '{"value":[]}')
                
                AVG_CPU=$(echo "$CPU_DATA" | jq -r '[.value[0].timeseries[0].data[]? | select(.average != null) | .average] | add / length // 0' 2>/dev/null || echo "0")
                
                # Get Network In
                NETWORK_IN_DATA=$(az monitor metrics list \
                    --resource "$VM_ID" \
                    --metric "Network In Total" \
                    --start-time "$(date -u -d "$DAYS_TO_CHECK days ago" '+%Y-%m-%dT%H:%M:%SZ')" \
                    --interval PT1H \
                    --aggregation Total \
                    -o json 2>/dev/null || echo '{"value":[]}')
                
                TOTAL_NETWORK_IN=$(echo "$NETWORK_IN_DATA" | jq -r '[.value[0].timeseries[0].data[]? | select(.total != null) | .total] | add // 0' 2>/dev/null || echo "0")
                
                # Get Network Out
                NETWORK_OUT_DATA=$(az monitor metrics list \
                    --resource "$VM_ID" \
                    --metric "Network Out Total" \
                    --start-time "$(date -u -d "$DAYS_TO_CHECK days ago" '+%Y-%m-%dT%H:%M:%SZ')" \
                    --interval PT1H \
                    --aggregation Total \
                    -o json 2>/dev/null || echo '{"value":[]}')
                
                TOTAL_NETWORK_OUT=$(echo "$NETWORK_OUT_DATA" | jq -r '[.value[0].timeseries[0].data[]? | select(.total != null) | .total] | add // 0' 2>/dev/null || echo "0")
                
                # Convert to GB
                NETWORK_IN_GB=$(echo "scale=2; $TOTAL_NETWORK_IN / 1073741824" | bc 2>/dev/null || echo "0")
                NETWORK_OUT_GB=$(echo "scale=2; $TOTAL_NETWORK_OUT / 1073741824" | bc 2>/dev/null || echo "0")
                NETWORK_IO="${NETWORK_IN_GB}GB/${NETWORK_OUT_GB}GB"
                
                # Get last time CPU was > 10% (indicating actual work)
                LAST_SIGNIFICANT_CPU=$(echo "$CPU_DATA" | jq -r '[.value[0].timeseries[0].data[]? | select(.average != null and .average > 10) | .timeStamp] | sort | reverse | .[0] // "Never"' 2>/dev/null || echo "Never")
                
                if [ "$LAST_SIGNIFICANT_CPU" != "Never" ]; then
                    LAST_USED="$LAST_SIGNIFICANT_CPU"
                    LAST_USED_EPOCH=$(date -d "$LAST_USED" +%s 2>/dev/null || echo "0")
                    CURRENT_EPOCH=$(date +%s)
                    DAYS_SINCE_USED=$((( CURRENT_EPOCH - LAST_USED_EPOCH ) / 86400))
                fi
                
                # Determine usage status based on metrics
                AVG_CPU_INT=$(printf "%.0f" "$AVG_CPU" 2>/dev/null || echo "0")
                NETWORK_IN_INT=$(printf "%.0f" "$NETWORK_IN_GB" 2>/dev/null || echo "0")
                
                echo "  Average CPU: ${AVG_CPU}%"
                echo "  Network I/O: $NETWORK_IO (last $DAYS_TO_CHECK days)"
                
                if (( $(echo "$AVG_CPU > 5" | bc -l 2>/dev/null || echo "0") )) || (( $(echo "$NETWORK_IN_GB > 1" | bc -l 2>/dev/null || echo "0") )); then
                    USAGE_STATUS="IN_USE"
                    USAGE_INDICATOR="CPU: ${AVG_CPU}% | Network: ${NETWORK_IO}"
                    RECOMMENDATION="Keep running"
                    IN_USE=$((IN_USE + 1))
                    echo -e "  ${GREEN}✓ IN USE - Showing actual utilization${NC}"
                elif [ "$DAYS_SINCE_USED" != "N/A" ] && [ $DAYS_SINCE_USED -gt $DAYS_TO_CHECK ]; then
                    USAGE_STATUS="UNUSED"
                    USAGE_INDICATOR="No significant activity in $DAYS_TO_CHECK days"
                    RECOMMENDATION="Stop/Deallocate - Wasting cost"
                    UNUSED=$((UNUSED + 1))
                    echo -e "  ${RED}✗ UNUSED - No activity for $DAYS_SINCE_USED days${NC}"
                else
                    USAGE_STATUS="IDLE"
                    USAGE_INDICATOR="Running but minimal usage (CPU: ${AVG_CPU}%)"
                    RECOMMENDATION="Review necessity - potential waste"
                    IDLE=$((IDLE + 1))
                    echo -e "  ${YELLOW}⚠ IDLE - Running but barely used${NC}"
                fi
            else
                USAGE_STATUS="STOPPED"
                RECOMMENDATION="Already stopped - OK"
                echo -e "  ${CYAN}⊗ STOPPED${NC}"
            fi
            
            # Write to CSV
            echo "$SUB_NAME,$SUB_ID,$VM_NAME,Microsoft.Compute/virtualMachines,$VM_RG,N/A,$IS_RUNNING,$USAGE_INDICATOR,$LAST_USED,$DAYS_SINCE_USED,$AVG_CPU,$AVG_MEMORY,$NETWORK_IO,$USAGE_STATUS,$RECOMMENDATION,$MONTHLY_COST" >> "$OUTPUT_FILE"
            echo ""
        done
    fi
    
    echo ""
    echo "Analyzing Storage Accounts..."
    echo "------------------------------------------------------------"
    
    # Get all storage accounts
    az storage account list --query "[].{name:name,id:id,rg:resourceGroup}" -o json > "$TEMP_DIR/storage.json" 2>/dev/null || echo "[]" > "$TEMP_DIR/storage.json"
    
    STORAGE_COUNT=$(jq '. | length' "$TEMP_DIR/storage.json")
    
    if [ $STORAGE_COUNT -gt 0 ]; then
        jq -c '.[]' "$TEMP_DIR/storage.json" | while read -r storage; do
            TOTAL_RESOURCES=$((TOTAL_RESOURCES + 1))
            
            STORAGE_NAME=$(echo "$storage" | jq -r '.name')
            STORAGE_ID=$(echo "$storage" | jq -r '.id')
            STORAGE_RG=$(echo "$storage" | jq -r '.rg')
            
            echo -e "${YELLOW}Checking Storage: $STORAGE_NAME${NC}"
            
            # Get transaction metrics (actual usage indicator)
            TRANSACTIONS=$(az monitor metrics list \
                --resource "$STORAGE_ID" \
                --metric "Transactions" \
                --start-time "$(date -u -d "$DAYS_TO_CHECK days ago" '+%Y-%m-%dT%H:%M:%SZ')" \
                --interval PT1H \
                --aggregation Total \
                -o json 2>/dev/null || echo '{"value":[]}')
            
            TOTAL_TRANSACTIONS=$(echo "$TRANSACTIONS" | jq -r '[.value[0].timeseries[0].data[]? | select(.total != null) | .total] | add // 0' 2>/dev/null || echo "0")
            
            # Get last transaction date
            LAST_TRANSACTION=$(echo "$TRANSACTIONS" | jq -r '[.value[0].timeseries[0].data[]? | select(.total != null and .total > 0) | .timeStamp] | sort | reverse | .[0] // "Never"' 2>/dev/null || echo "Never")
            
            DAYS_SINCE_USED="N/A"
            if [ "$LAST_TRANSACTION" != "Never" ]; then
                LAST_USED_EPOCH=$(date -d "$LAST_TRANSACTION" +%s 2>/dev/null || echo "0")
                CURRENT_EPOCH=$(date +%s)
                DAYS_SINCE_USED=$((( CURRENT_EPOCH - LAST_USED_EPOCH ) / 86400))
            fi
            
            echo "  Total Transactions (last $DAYS_TO_CHECK days): $TOTAL_TRANSACTIONS"
            
            if [ "$TOTAL_TRANSACTIONS" -gt 1000 ]; then
                USAGE_STATUS="IN_USE"
                RECOMMENDATION="Keep - Active storage"
                IN_USE=$((IN_USE + 1))
                echo -e "  ${GREEN}✓ IN USE - $TOTAL_TRANSACTIONS transactions${NC}"
            elif [ "$TOTAL_TRANSACTIONS" -gt 0 ]; then
                USAGE_STATUS="IDLE"
                RECOMMENDATION="Review - Low usage"
                IDLE=$((IDLE + 1))
                echo -e "  ${YELLOW}⚠ IDLE - Only $TOTAL_TRANSACTIONS transactions${NC}"
            else
                USAGE_STATUS="UNUSED"
                RECOMMENDATION="Delete - No activity"
                UNUSED=$((UNUSED + 1))
                echo -e "  ${RED}✗ UNUSED - No transactions in $DAYS_TO_CHECK days${NC}"
            fi
            
            echo "$SUB_NAME,$SUB_ID,$STORAGE_NAME,Microsoft.Storage/storageAccounts,$STORAGE_RG,N/A,Yes,Transactions: $TOTAL_TRANSACTIONS,$LAST_TRANSACTION,$DAYS_SINCE_USED,N/A,N/A,N/A,$USAGE_STATUS,$RECOMMENDATION,Unknown" >> "$OUTPUT_FILE"
            echo ""
        done
    fi
    
    echo ""
    echo "Analyzing SQL Databases..."
    echo "------------------------------------------------------------"
    
    # Get all SQL databases
    az sql db list --query "[?name != 'master'].{name:name,server:managedBy,id:id,rg:resourceGroup}" -o json 2>/dev/null > "$TEMP_DIR/sqldbs.json" || echo "[]" > "$TEMP_DIR/sqldbs.json"
    
    SQL_COUNT=$(jq '. | length' "$TEMP_DIR/sqldbs.json")
    
    if [ $SQL_COUNT -gt 0 ]; then
        jq -c '.[]' "$TEMP_DIR/sqldbs.json" | while read -r sqldb; do
            TOTAL_RESOURCES=$((TOTAL_RESOURCES + 1))
            
            DB_NAME=$(echo "$sqldb" | jq -r '.name')
            DB_ID=$(echo "$sqldb" | jq -r '.id')
            DB_RG=$(echo "$sqldb" | jq -r '.rg')
            
            echo -e "${YELLOW}Checking SQL DB: $DB_NAME${NC}"
            
            # Get connection count (actual usage)
            CONNECTIONS=$(az monitor metrics list \
                --resource "$DB_ID" \
                --metric "connection_successful" \
                --start-time "$(date -u -d "$DAYS_TO_CHECK days ago" '+%Y-%m-%dT%H:%M:%SZ')" \
                --interval PT1H \
                --aggregation Total \
                -o json 2>/dev/null || echo '{"value":[]}')
            
            TOTAL_CONNECTIONS=$(echo "$CONNECTIONS" | jq -r '[.value[0].timeseries[0].data[]? | select(.total != null) | .total] | add // 0' 2>/dev/null || echo "0")
            
            # Get CPU usage
            CPU_PERCENT=$(az monitor metrics list \
                --resource "$DB_ID" \
                --metric "cpu_percent" \
                --start-time "$(date -u -d "$DAYS_TO_CHECK days ago" '+%Y-%m-%dT%H:%M:%SZ')" \
                --interval PT1H \
                --aggregation Average \
                -o json 2>/dev/null || echo '{"value":[]}')
            
            AVG_CPU=$(echo "$CPU_PERCENT" | jq -r '[.value[0].timeseries[0].data[]? | select(.average != null) | .average] | add / length // 0' 2>/dev/null || echo "0")
            
            # Last connection
            LAST_CONNECTION=$(echo "$CONNECTIONS" | jq -r '[.value[0].timeseries[0].data[]? | select(.total != null and .total > 0) | .timeStamp] | sort | reverse | .[0] // "Never"' 2>/dev/null || echo "Never")
            
            DAYS_SINCE_USED="N/A"
            if [ "$LAST_CONNECTION" != "Never" ]; then
                LAST_USED_EPOCH=$(date -d "$LAST_CONNECTION" +%s 2>/dev/null || echo "0")
                CURRENT_EPOCH=$(date +%s)
                DAYS_SINCE_USED=$((( CURRENT_EPOCH - LAST_USED_EPOCH ) / 86400))
            fi
            
            echo "  Total Connections (last $DAYS_TO_CHECK days): $TOTAL_CONNECTIONS"
            echo "  Average CPU: ${AVG_CPU}%"
            
            if [ "$TOTAL_CONNECTIONS" -gt 100 ]; then
                USAGE_STATUS="IN_USE"
                RECOMMENDATION="Keep - Active database"
                IN_USE=$((IN_USE + 1))
                echo -e "  ${GREEN}✓ IN USE - $TOTAL_CONNECTIONS connections${NC}"
            elif [ "$TOTAL_CONNECTIONS" -gt 0 ]; then
                USAGE_STATUS="IDLE"
                RECOMMENDATION="Review - Low connection count"
                IDLE=$((IDLE + 1))
                echo -e "  ${YELLOW}⚠ IDLE - Only $TOTAL_CONNECTIONS connections${NC}"
            else
                USAGE_STATUS="UNUSED"
                RECOMMENDATION="Delete or export data"
                UNUSED=$((UNUSED + 1))
                echo -e "  ${RED}✗ UNUSED - No connections in $DAYS_TO_CHECK days${NC}"
            fi
            
            echo "$SUB_NAME,$SUB_ID,$DB_NAME,Microsoft.Sql/servers/databases,$DB_RG,N/A,Yes,Connections: $TOTAL_CONNECTIONS | CPU: ${AVG_CPU}%,$LAST_CONNECTION,$DAYS_SINCE_USED,$AVG_CPU,N/A,N/A,$USAGE_STATUS,$RECOMMENDATION,Unknown" >> "$OUTPUT_FILE"
            echo ""
        done
    fi
    
    echo ""
    
done < "$TEMP_DIR/subscriptions.txt"

# Cleanup
rm -rf "$TEMP_DIR"

# Final Summary
echo "========================================================="
echo "Usage Audit Complete!"
echo "========================================================="
echo "Total Resources Analyzed: $TOTAL_RESOURCES"
echo ""
echo -e "${GREEN}IN USE (Actually being utilized): $IN_USE${NC}"
echo -e "${YELLOW}IDLE (Running but minimal usage): $IDLE${NC}"
echo -e "${RED}UNUSED (No usage in $DAYS_TO_CHECK days): $UNUSED${NC}"
echo ""
echo "Potential Monthly Savings from UNUSED + IDLE resources: Contact finance for cost analysis"
echo ""
echo "Results saved to: $OUTPUT_FILE"
echo ""

# Show recommendations
if [ -f "$OUTPUT_FILE" ]; then
    echo "Top Resources to Consider for Cleanup:"
    echo "======================================="
    awk -F',' 'NR>1 && $14=="UNUSED" {printf "  [UNUSED] %s (%s) - RG: %s - %s\n", $3, $4, $5, $15}' "$OUTPUT_FILE" | head -20
    echo ""
    awk -F',' 'NR>1 && $14=="IDLE" {printf "  [IDLE] %s (%s) - RG: %s - %s\n", $3, $4, $5, $15}' "$OUTPUT_FILE" | head -20
fi
