#!/usr/bin/env bash
set -euo pipefail

OUTFILE="${1:-synapse_full_backup_report.csv}"

echo 'subscriptionId,subscriptionName,resourceGroup,workspaceName,sqlPoolName,geoBackupPolicy,lastGeoBackupTime,databaseSizeGB,approxBackupSizeGB' > "$OUTFILE"

# Prerequisite check
if ! command -v az >/dev/null 2>&1; then
  echo "Azure CLI not found. Install it first: https://aka.ms/azcli" >&2
  exit 1
fi

if ! az account show >/dev/null 2>&1; then
  echo "Please login first using: az login" >&2
  exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
  echo "jq not found. Please install jq to parse JSON." >&2
  exit 1
fi

# Loop through all active subscriptions
SUBS=$(az account list --all --query "[?state=='Enabled'].id" -o tsv)
for SUB_ID in $SUBS; do
  SUB_NAME=$(az account show --subscription "$SUB_ID" --query name -o tsv)
  echo "ðŸ” Checking Synapse workspaces in: $SUB_NAME"

  WORKSPACES=$(az synapse workspace list --subscription "$SUB_ID" --query "[].{rg:resourceGroup,name:name}" -o tsv || true)
  [ -n "$WORKSPACES" ] || continue

  while IFS=$'\t' read -r RG WS || [ -n "${WS:-}" ]; do
    [ -n "$WS" ] || continue
    echo "   â†’ Workspace: $WS"

    POOLS=$(az synapse sql pool list --subscription "$SUB_ID" --resource-group "$RG" --workspace-name "$WS" --query "[].name" -o tsv || true)
    [ -n "$POOLS" ] || continue

    for POOL in $POOLS; do
      echo "      Pool: $POOL"

      # Get Geo-backup policy info
      POLICY_JSON=$(az synapse sql pool geo-backup-policy show \
        --subscription "$SUB_ID" \
        --resource-group "$RG" \
        --workspace-name "$WS" \
        --name "$POOL" 2>/dev/null || echo "{}")

      GEO_POLICY=$(echo "$POLICY_JSON" | jq -r '.state // "N/A"')
      LAST_BACKUP=$(echo "$POLICY_JSON" | jq -r '.lastGeoBackupTime // "N/A"')

      # Get DB size in bytes â†’ convert to GB
      DB_SIZE_BYTES=$(az synapse sql pool show \
        --subscription "$SUB_ID" \
        --resource-group "$RG" \
        --workspace-name "$WS" \
        --name "$POOL" \
        --query "maxSizeBytes" -o tsv 2>/dev/null || echo 0)

      DB_SIZE_GB=$(awk "BEGIN {printf \"%.2f\", $DB_SIZE_BYTES / (1024^3)}")
      APPROX_BACKUP_GB=$(awk "BEGIN {printf \"%.2f\", $DB_SIZE_GB * 0.30}")

      echo "\"$SUB_ID\",\"$SUB_NAME\",\"$RG\",\"$WS\",\"$POOL\",\"$GEO_POLICY\",\"$LAST_BACKUP\",$DB_SIZE_GB,$APPROX_BACKUP_GB" >> "$OUTFILE"
    done
  done <<< "$WORKSPACES"
done

echo "âœ… Done. Report saved to $OUTFILE"
