#!/usr/bin/env bash
set -euo pipefail

# -------------------------------------------------------
# Filters (change if needed)
# -------------------------------------------------------
# IMPORTANT: Many sub-assessments are NotApplicable/Healthy/etc.
# If you filter only Unhealthy you might get 0 rows.
STATUS_FILTER="${STATUS_FILTER:-ALL}"   # ALL | Unhealthy | Healthy | NotApplicable

# Optional time range to reduce output size: 1h, 24h, 7d, 30d
TIME_RANGE="${TIME_RANGE:-}"           # e.g. "7d" or "" (no filter)

PAGE_SIZE="${PAGE_SIZE:-1000}"         # ARG max is 1000

TS="$(date -u +%Y%m%dT%H%M%SZ)"
OUT_DIR="defender_subassessments_export_${TS}"
mkdir -p "$OUT_DIR"

OUT_CSV="${OUT_DIR}/defender_subassessments.csv"
OUT_JSONL="${OUT_DIR}/defender_subassessments.jsonl"

# -------------------------------------------------------
# Prereqs
# -------------------------------------------------------
az extension add --name resource-graph --upgrade -o none >/dev/null 2>&1 || true

if ! command -v jq >/dev/null 2>&1; then
  echo "ERROR: jq not found. (Azure Cloud Shell normally has it.)" >&2
  exit 1
fi

# -------------------------------------------------------
# Get enabled subscriptions (id + name) WITHOUT mapfile
# -------------------------------------------------------
subs_list="$(az account list --query "[?state=='Enabled'].{id:id,name:name}" -o tsv 2>/dev/null || true)"
if [ -z "$subs_list" ]; then
  echo "ERROR: No enabled subscriptions returned by az account list." >&2
  echo "Try: az account list -o table" >&2
  exit 1
fi

# -------------------------------------------------------
# Azure Resource Graph query for sub-assessments
# -------------------------------------------------------
KQL_BASE=$(cat <<'KQL'
securityresources
| where type =~ "microsoft.security/assessments/subassessments"
| extend assessmentKey = tostring(extract(@"(?i)providers/Microsoft.Security/assessments/([^/]*)", 1, id))
| extend subAssessmentKey = tostring(name)
| extend parentResourceId = tostring(extract(@"(?i)^(.*)/providers/Microsoft.Security/assessments/[^/]+/subassessments/[^/]+$", 1, id))
| extend rgFromId = tostring(extract(@"(?i)/resourceGroups/([^/]+)", 1, parentResourceId))
| extend resourceGroupName = tostring(coalesce(tostring(resourceGroup), rgFromId))
| extend statusCode = tostring(properties.status.code)
| extend statusSeverity = tostring(properties.status.severity)
| extend timeGenerated = todatetime(properties.timeGenerated)
| extend findingDisplayName = tostring(properties.displayName)
| extend description = tostring(properties.description)
| extend remediation = tostring(properties.remediation)
| extend portalUri = tostring(properties.links.azurePortalUri)
| extend assessedResourceType = tostring(properties.additionalData.assessedResourceType)
| extend vulnSeverity = tostring(properties.additionalData.vulnerabilityDetails.severity)
| extend cve = tostring(properties.additionalData.cve)
| extend packageName = tostring(properties.additionalData.softwareDetails.packageName)
| extend additionalData = properties.additionalData
| project
    subscriptionId=tostring(subscriptionId),
    resourceGroup=resourceGroupName,
    parentResourceId,
    assessmentKey,
    subAssessmentKey,
    statusCode,
    statusSeverity,
    timeGenerated,
    assessedResourceType,
    vulnSeverity,
    cve,
    packageName,
    findingDisplayName,
    description,
    remediation,
    portalUri,
    subAssessmentResourceId=tostring(id),
    additionalData
KQL
)

KQL="$KQL_BASE"

if [ "$STATUS_FILTER" != "ALL" ]; then
  KQL="$KQL
| where statusCode =~ \"$STATUS_FILTER\""
fi

if [ -n "$TIME_RANGE" ]; then
  KQL="$KQL
| where timeGenerated > ago($TIME_RANGE)"
fi

# -------------------------------------------------------
# Output headers
# -------------------------------------------------------
echo '"subscriptionId","subscriptionName","resourceGroup","parentResourceId","assessmentKey","subAssessmentKey","statusCode","statusSeverity","timeGenerated","assessedResourceType","vulnSeverity","cve","packageName","findingDisplayName","description","remediation","portalUri","subAssessmentResourceId","additionalData"' > "$OUT_CSV"
: > "$OUT_JSONL"

# -------------------------------------------------------
# Loop through subscriptions and export with pagination
# -------------------------------------------------------
while IFS=$'\t' read -r sub_id sub_name; do
  [ -z "$sub_id" ] && continue
  echo "Exporting sub-assessments from: $sub_id ($sub_name)" >&2

  skip_token=""
  while :; do
    if [ -z "$skip_token" ]; then
      resp="$(az graph query -q "$KQL" --subscriptions "$sub_id" --first "$PAGE_SIZE" -o json)"
    else
      resp="$(az graph query -q "$KQL" --subscriptions "$sub_id" --first "$PAGE_SIZE" --skip-token "$skip_token" -o json)"
    fi

    # JSONL (keep additionalData structured in JSONL)
    echo "$resp" | jq -c --arg subName "$sub_name" '
      .data[] | .subscriptionName=$subName
    ' >> "$OUT_JSONL"

    # CSV (flatten additionalData to a single string for Excel)
    echo "$resp" | jq -r --arg subName "$sub_name" '
      .data[] |
      [
        .subscriptionId,
        $subName,
        .resourceGroup,
        .parentResourceId,
        .assessmentKey,
        .subAssessmentKey,
        .statusCode,
        .statusSeverity,
        (.timeGenerated // ""),
        .assessedResourceType,
        .vulnSeverity,
        .cve,
        .packageName,
        .findingDisplayName,
        .description,
        .remediation,
        .portalUri,
        .subAssessmentResourceId,
        (.additionalData | tostring)
      ]
      | map(if .==null then "" else (tostring | gsub("\r\n|\n|\r"; " ")) end)
      | @csv
    ' >> "$OUT_CSV"

    skip_token="$(echo "$resp" | jq -r '.skipToken // empty')"
    [ -z "$skip_token" ] && break
  done

done <<< "$subs_list"

echo ""
echo "DONE"
echo "CSV  : $OUT_CSV"
echo "JSONL: $OUT_JSONL"
echo ""
echo "Cloud Shell download: Manage files -> Download"
