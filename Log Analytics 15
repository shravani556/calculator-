#!/bin/bash

# Log Analytics Workspace Activity Analyzer with CSV Export
# This script checks Azure Log Analytics workspaces for log activity
# Generates a CSV file with detailed information

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Generate timestamp for filename
TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
OUTPUT_FILE="LAW_Final_Report_${TIMESTAMP}.csv"

# Check if Azure CLI is installed
if ! command -v az &> /dev/null; then
    echo -e "${RED}Error: Azure CLI is not installed${NC}"
    echo "Please install it from: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli"
    exit 1
fi

# Check if logged in
if ! az account show &> /dev/null; then
    echo -e "${RED}Error: Not logged in to Azure${NC}"
    echo "Please run: az login"
    exit 1
fi

echo -e "${BLUE}=== Log Analytics Workspace Activity Report ===${NC}\n"

# Show all available subscriptions
echo -e "${CYAN}Available Subscriptions:${NC}"
az account list --query "[].{Name:name, ID:id, State:state}" -o table
echo ""

# Get current subscription
SUBSCRIPTION=$(az account show --query name -o tsv)
SUBSCRIPTION_ID=$(az account show --query id -o tsv)
echo -e "${GREEN}Currently using subscription:${NC}"
echo -e "${GREEN}  Name: ${SUBSCRIPTION}${NC}"
echo -e "${GREEN}  ID: ${SUBSCRIPTION_ID}${NC}\n"

# Ask if user wants to change subscription
read -p "Do you want to use this subscription? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "\n${YELLOW}Available subscriptions:${NC}"
    az account list --query "[].{Name:name, ID:id}" -o table
    echo ""
    read -p "Enter subscription ID or name: " SUB_INPUT
    az account set --subscription "$SUB_INPUT"
    SUBSCRIPTION=$(az account show --query name -o tsv)
    SUBSCRIPTION_ID=$(az account show --query id -o tsv)
    echo -e "${GREEN}Switched to: ${SUBSCRIPTION}${NC}\n"
fi

# Calculate date 90 days ago
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    START_DATE=$(date -u -v-90d '+%Y-%m-%dT%H:%M:%SZ')
else
    # Linux
    START_DATE=$(date -u -d '90 days ago' '+%Y-%m-%dT%H:%M:%SZ')
fi

END_DATE=$(date -u '+%Y-%m-%dT%H:%M:%SZ')

echo -e "${YELLOW}Analyzing log activity from ${START_DATE} to ${END_DATE}${NC}\n"

# Create CSV header
echo "SubscriptionName,SubscriptionID,WorkspaceName,ResourceGroup,Location,WorkspaceID,SKU,RetentionDays,LastLogDate,DaysActiveIn90Days,ActivityPercentage,TotalRecordsLast90Days,TopTable1,TopTable1Records,TopTable2,TopTable2Records,TopTable3,TopTable3Records,Status" > "$OUTPUT_FILE"

echo -e "${CYAN}Searching for Log Analytics workspaces...${NC}\n"

# Get all Log Analytics workspaces with more details
WORKSPACES=$(az monitor log-analytics workspace list -o json 2>/dev/null)

if [ -z "$WORKSPACES" ] || [ "$WORKSPACES" == "[]" ] || [ "$WORKSPACES" == "null" ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}No Log Analytics workspaces found in subscription: ${SUBSCRIPTION}${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
    
    # Write to CSV
    echo "\"$SUBSCRIPTION\",\"$SUBSCRIPTION_ID\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",0,0,0,\"N/A\",0,\"N/A\",0,\"N/A\",0,\"No workspaces found\"" >> "$OUTPUT_FILE"
    
    echo -e "${YELLOW}Possible reasons:${NC}"
    echo "  1. No Log Analytics workspaces exist in this subscription"
    echo "  2. You may not have permissions to view workspaces"
    echo "  3. You may be in the wrong subscription"
    echo ""
    echo -e "${GREEN}CSV file created: ${OUTPUT_FILE}${NC}"
    exit 0
fi

WORKSPACE_COUNT=$(echo "$WORKSPACES" | jq length)
echo -e "${GREEN}âœ“ Found ${WORKSPACE_COUNT} workspace(s) in subscription${NC}\n"

CURRENT=0

# Process each workspace
echo "$WORKSPACES" | jq -c '.[]' | while read -r workspace; do
    CURRENT=$((CURRENT + 1))
    
    WORKSPACE_NAME=$(echo "$workspace" | jq -r '.name')
    RESOURCE_GROUP=$(echo "$workspace" | jq -r '.resourceGroup')
    LOCATION=$(echo "$workspace" | jq -r '.location')
    WORKSPACE_ID=$(echo "$workspace" | jq -r '.id')
    SKU=$(echo "$workspace" | jq -r '.sku.name // "N/A"')
    RETENTION=$(echo "$workspace" | jq -r '.retentionInDays // "N/A"')
    
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}[$CURRENT/$WORKSPACE_COUNT] Workspace: ${WORKSPACE_NAME}${NC}"
    echo -e "  Resource Group: ${RESOURCE_GROUP}"
    echo -e "  Location: ${LOCATION}"
    echo -e "  SKU: ${SKU}"
    echo -e "  Retention: ${RETENTION} days"
    echo ""
    
    # Initialize variables
    LAST_LOG_DATE="No logs"
    DAYS_COUNT="0"
    PERCENTAGE="0.0"
    TOTAL_RECORDS="0"
    STATUS="Inactive"
    TABLE1="N/A"
    TABLE1_COUNT="0"
    TABLE2="N/A"
    TABLE2_COUNT="0"
    TABLE3="N/A"
    TABLE3_COUNT="0"
    
    # Query for last log entry and total records
    SUMMARY_QUERY="union withsource=TableName *
| where TimeGenerated >= ago(90d)
| summarize LastLog = max(TimeGenerated), TotalRecords = count()"
    
    echo "  ğŸ“Š Querying workspace data..."
    SUMMARY=$(az monitor log-analytics query -w "$WORKSPACE_ID" --analytics-query "$SUMMARY_QUERY" -o json 2>/dev/null || echo "[]")
    
    if [ "$SUMMARY" != "[]" ] && [ "$(echo "$SUMMARY" | jq length)" -gt 0 ]; then
        LAST_LOG_DATE=$(echo "$SUMMARY" | jq -r '.[0].LastLog // "No logs"' 2>/dev/null)
        TOTAL_RECORDS=$(echo "$SUMMARY" | jq -r '.[0].TotalRecords // "0"' 2>/dev/null)
        
        if [ "$LAST_LOG_DATE" != "null" ] && [ "$LAST_LOG_DATE" != "No logs" ] && [ -n "$LAST_LOG_DATE" ]; then
            echo -e "  ${GREEN}âœ“ Last Log Date: ${LAST_LOG_DATE}${NC}"
            echo -e "  ${GREEN}âœ“ Total Records (90d): ${TOTAL_RECORDS}${NC}"
            STATUS="Active"
        else
            LAST_LOG_DATE="No logs"
            echo -e "  ${YELLOW}âš  No logs found in the past 90 days${NC}"
        fi
    else
        echo -e "  ${YELLOW}âš  No logs found in the past 90 days${NC}"
    fi
    
    # Query for active days in last 90 days
    if [ "$STATUS" == "Active" ]; then
        ACTIVE_DAYS_QUERY="union withsource=TableName *
| where TimeGenerated >= ago(90d)
| summarize by bin(TimeGenerated, 1d)
| count"
        
        echo "  ğŸ“… Calculating active days..."
        ACTIVE_DAYS=$(az monitor log-analytics query -w "$WORKSPACE_ID" --analytics-query "$ACTIVE_DAYS_QUERY" -o json 2>/dev/null || echo "[]")
        
        if [ "$ACTIVE_DAYS" != "[]" ] && [ "$(echo "$ACTIVE_DAYS" | jq length)" -gt 0 ]; then
            DAYS_COUNT=$(echo "$ACTIVE_DAYS" | jq -r '.[0].Count // "0"' 2>/dev/null)
            
            if [ "$DAYS_COUNT" != "null" ] && [ -n "$DAYS_COUNT" ] && [ "$DAYS_COUNT" != "0" ]; then
                PERCENTAGE=$(echo "scale=2; ($DAYS_COUNT / 90) * 100" | bc 2>/dev/null || echo "0.00")
                echo -e "  ${GREEN}âœ“ Active Days: ${DAYS_COUNT}/90 (${PERCENTAGE}%)${NC}"
            fi
        fi
        
        # Get top 3 tables by record count
        TOP_TABLES_QUERY="union withsource=TableName *
| where TimeGenerated >= ago(90d)
| summarize RecordCount = count() by TableName
| top 3 by RecordCount desc"
        
        echo "  ğŸ“‹ Fetching top tables..."
        TOP_TABLES=$(az monitor log-analytics query -w "$WORKSPACE_ID" --analytics-query "$TOP_TABLES_QUERY" -o json 2>/dev/null || echo "[]")
        
        if [ "$TOP_TABLES" != "[]" ] && [ "$(echo "$TOP_TABLES" | jq length)" -gt 0 ]; then
            TABLE1=$(echo "$TOP_TABLES" | jq -r '.[0].TableName // "N/A"' 2>/dev/null)
            TABLE1_COUNT=$(echo "$TOP_TABLES" | jq -r '.[0].RecordCount // "0"' 2>/dev/null)
            TABLE2=$(echo "$TOP_TABLES" | jq -r '.[1].TableName // "N/A"' 2>/dev/null)
            TABLE2_COUNT=$(echo "$TOP_TABLES" | jq -r '.[1].RecordCount // "0"' 2>/dev/null)
            TABLE3=$(echo "$TOP_TABLES" | jq -r '.[2].TableName // "N/A"' 2>/dev/null)
            TABLE3_COUNT=$(echo "$TOP_TABLES" | jq -r '.[2].RecordCount // "0"' 2>/dev/null)
            
            echo -e "  ${BLUE}Top 3 Active Tables:${NC}"
            [ "$TABLE1" != "N/A" ] && echo -e "    1ï¸âƒ£  ${TABLE1}: ${TABLE1_COUNT} records"
            [ "$TABLE2" != "N/A" ] && echo -e "    2ï¸âƒ£  ${TABLE2}: ${TABLE2_COUNT} records"
            [ "$TABLE3" != "N/A" ] && echo -e "    3ï¸âƒ£  ${TABLE3}: ${TABLE3_COUNT} records"
        fi
    fi
    
    # Write to CSV (escape commas and quotes in fields)
    echo "\"$SUBSCRIPTION\",\"$SUBSCRIPTION_ID\",\"$WORKSPACE_NAME\",\"$RESOURCE_GROUP\",\"$LOCATION\",\"$WORKSPACE_ID\",\"$SKU\",\"$RETENTION\",\"$LAST_LOG_DATE\",$DAYS_COUNT,$PERCENTAGE,$TOTAL_RECORDS,\"$TABLE1\",$TABLE1_COUNT,\"$TABLE2\",$TABLE2_COUNT,\"$TABLE3\",$TABLE3_COUNT,\"$STATUS\"" >> "$OUTPUT_FILE"
    
    echo ""
done

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Analysis complete!${NC}\n"
echo -e "${CYAN}ğŸ“„ Report Details:${NC}"
echo "  â€¢ Report file: ${OUTPUT_FILE}"
echo "  â€¢ Workspaces analyzed: $WORKSPACE_COUNT"
echo "  â€¢ Subscription: $SUBSCRIPTION"
echo "  â€¢ Time range: Last 90 days"
echo ""
echo -e "${GREEN}âœ“ CSV file ready to open in Excel or any spreadsheet application${NC}"
echo ""
